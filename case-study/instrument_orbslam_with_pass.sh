#!/bin/bash

current_dir=$(pwd)

### Remove the buffer file
rm /tmp/id_index.txt

### Instrumenting ORB-SLAM Lib
echo "@-@ Instrumenting via ORB-SLAM Lib"

cd ${current_dir}/ORB_SLAM3/build/

${LLVM_DIR}/bin/llvm-link $(find ./CMakeFiles/ORB_SLAM3.dir/src/ -name '*.o') -o orb-slam3-src.ll 

${LLVM_DIR}/bin/opt -f -enable-new-pm=0 -load /home/cspl/Shore-user/Shore-GraphBuilder/SVF-program-analysis/Release-build/tools/Shore-Pass/TimingInstrumenter/libPassTimingInstrumenter.so -TimingInstrumenter orb-slam3-src.ll -o /tmp/lib_output.ll

mv /tmp/lib_output.ll ./orb-slam3-src.ll

/home/cspl/llvm-project/build/bin/clang++ -fPIC  -Wall   -O0 -flto -std=c++14 -O3 -DNDEBUG -march=native  -shared -Wl,-soname,libORB_SLAM3.so -o ../lib/libORB_SLAM3.so ../lib/libORB_SLAM3.so orb-slam3-src.ll  -Wl,-rpath,/home/cspl/Pangolin/build:/home/cspl/Shore-user/ORB_SLAM3/Thirdparty/DBoW2/lib:/home/cspl/Shore-user/ORB_SLAM3/Thirdparty/g2o/lib /usr/lib/x86_64-linux-gnu/libopencv_stitching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_aruco.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bgsegm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bioinspired.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ccalib.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dpm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_face.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_freetype.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_fuzzy.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hdf.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hfs.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_img_hash.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_line_descriptor.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_quality.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_reg.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_rgbd.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_saliency.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_shape.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_stereo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_structured_light.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_surface_matching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_tracking.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videostab.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_viz.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xobjdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xphoto.so.4.2.0 /home/cspl/Pangolin/build/libpango_glgeometry.so /home/cspl/Pangolin/build/libpango_plot.so /home/cspl/Pangolin/build/libpango_python.so /home/cspl/Pangolin/build/libpango_scene.so /home/cspl/Pangolin/build/libpango_tools.so /home/cspl/Pangolin/build/libpango_video.so ../Thirdparty/DBoW2/lib/libDBoW2.so ../Thirdparty/g2o/lib/libg2o.so -lboost_serialization -lcrypto /usr/lib/x86_64-linux-gnu/libopencv_highgui.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_datasets.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_plot.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_text.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ml.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_phase_unwrapping.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_optflow.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ximgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_video.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videoio.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgcodecs.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_calib3d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_features2d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_flann.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_photo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_core.so.4.2.0 /home/cspl/Pangolin/build/libpango_geometry.so /home/cspl/Pangolin/build/libtinyobj.so /home/cspl/Pangolin/build/libpango_display.so /home/cspl/Pangolin/build/libpango_vars.so /home/cspl/Pangolin/build/libpango_windowing.so /home/cspl/Pangolin/build/libpango_opengl.so -lGLEW -lOpenGL -lGLX -lGLU /home/cspl/Pangolin/build/libpango_image.so /home/cspl/Pangolin/build/libpango_packetstream.so /home/cspl/Pangolin/build/libpango_core.so -lrt -lpthread


### Instrumenting ORB-SLAM ROS Node
echo "@-@ Instrumenting via ORB-SLAM ROS Node"

cd ${current_dir}/catkin_ws/build

${LLVM_DIR}/bin/opt  -f -enable-new-pm=0 -load /home/cspl/Shore-user/Shore-GraphBuilder/SVF-program-analysis/Release-build/tools/Shore-Pass/TimingInstrumenter/libPassTimingInstrumenter.so -TimingInstrumenter ./orb_slam3_ros_wrapper/CMakeFiles/orb_slam3_ros_wrapper_stereo_inertial.dir/src/stereo_inertial_node.cc.o -o /tmp/output.bc

mv /tmp/output.bc ./orb_slam3_ros_wrapper/CMakeFiles/orb_slam3_ros_wrapper_stereo_inertial.dir/src/stereo_inertial_node.cc.o


echo "Linking the ROS Node"

/home/cspl/llvm-project/build/bin/clang++  -std=c++14 -O3 -g -Wno-c++11-narrowing -flto  -flto -rdynamic ./orb_slam3_ros_wrapper/CMakeFiles/orb_slam3_ros_wrapper_stereo_inertial.dir/src/stereo_inertial_node.cc.o /home/cspl/Shore-user/Shore-TimingAnnotation/build/ROS_enabled_instrumentation_lib.ll ./orb_slam3_ros_wrapper/CMakeFiles/orb_slam3_ros_wrapper_stereo_inertial.dir/src/common.cc.o  -o ../devel/lib/orb_slam3_ros_wrapper/orb_slam3_ros_wrapper_stereo_inertial  -Wl,-rpath,/home/cspl/Shore-user/case-study/ORB_SLAM3/lib:/home/cspl/ros_catkin_ws/install_isolated/lib:/home/cspl/Pangolin/build /home/cspl/Shore-user/case-study/ORB_SLAM3/lib/libORB_SLAM3.so /home/cspl/ros_catkin_ws/install_isolated/lib/libcv_bridge.so /usr/lib/x86_64-linux-gnu/libopencv_calib3d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_features2d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_flann.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_highgui.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ml.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_photo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_stitching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_video.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videoio.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_aruco.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bgsegm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bioinspired.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ccalib.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_datasets.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dpm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_face.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_freetype.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_fuzzy.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hdf.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hfs.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_img_hash.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_line_descriptor.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_optflow.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_phase_unwrapping.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_plot.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_quality.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_reg.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_rgbd.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_saliency.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_shape.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_stereo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_structured_light.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_surface_matching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_text.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_tracking.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videostab.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_viz.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ximgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xobjdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xphoto.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_core.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgcodecs.so.4.2.0 /home/cspl/ros_catkin_ws/install_isolated/lib/libimage_transport.so /home/cspl/ros_catkin_ws/install_isolated/lib/libclass_loader.so -lPocoFoundation -ldl /home/cspl/ros_catkin_ws/install_isolated/lib/libroslib.so /home/cspl/ros_catkin_ws/install_isolated/lib/librospack.so -lpython3.8 /usr/lib/x86_64-linux-gnu/libboost_program_options.so.1.71.0 -ltinyxml2 /home/cspl/ros_catkin_ws/install_isolated/lib/libtf.so /home/cspl/ros_catkin_ws/install_isolated/lib/libtf2_ros.so /home/cspl/ros_catkin_ws/install_isolated/lib/libactionlib.so /home/cspl/ros_catkin_ws/install_isolated/lib/libmessage_filters.so /home/cspl/ros_catkin_ws/install_isolated/lib/libroscpp.so -lpthread /usr/lib/x86_64-linux-gnu/libboost_chrono.so.1.71.0 /usr/lib/x86_64-linux-gnu/libboost_filesystem.so.1.71.0 /home/cspl/ros_catkin_ws/install_isolated/lib/libxmlrpcpp.so /home/cspl/ros_catkin_ws/install_isolated/lib/libtf2.so /home/cspl/ros_catkin_ws/install_isolated/lib/librosconsole.so /home/cspl/ros_catkin_ws/install_isolated/lib/librosconsole_log4cxx.so /home/cspl/ros_catkin_ws/install_isolated/lib/librosconsole_backend_interface.so -llog4cxx /usr/lib/x86_64-linux-gnu/libboost_regex.so.1.71.0 /home/cspl/ros_catkin_ws/install_isolated/lib/libroscpp_serialization.so /home/cspl/ros_catkin_ws/install_isolated/lib/librostime.so /usr/lib/x86_64-linux-gnu/libboost_date_time.so.1.71.0 /home/cspl/ros_catkin_ws/install_isolated/lib/libcpp_common.so /usr/lib/x86_64-linux-gnu/libboost_system.so.1.71.0 /usr/lib/x86_64-linux-gnu/libboost_thread.so.1.71.0 /usr/lib/x86_64-linux-gnu/libconsole_bridge.so.0.4 /home/cspl/Pangolin/build/libpango_glgeometry.so /home/cspl/Pangolin/build/libpango_plot.so /home/cspl/Pangolin/build/libpango_python.so /home/cspl/Pangolin/build/libpango_scene.so /home/cspl/Pangolin/build/libpango_tools.so /home/cspl/Pangolin/build/libpango_video.so /usr/lib/x86_64-linux-gnu/libopencv_stitching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_aruco.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bgsegm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_bioinspired.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ccalib.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dpm.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_face.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_freetype.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_fuzzy.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hdf.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_hfs.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_img_hash.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_line_descriptor.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_quality.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_reg.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_rgbd.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_saliency.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_shape.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_stereo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_structured_light.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_superres.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_surface_matching.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_tracking.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videostab.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_viz.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xobjdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_xphoto.so.4.2.0 -lboost_system /home/cspl/Shore-user/case-study/ORB_SLAM3/lib/libTimingAnnotationAPI.so /home/cspl/Pangolin/build/libpango_geometry.so /home/cspl/Pangolin/build/libtinyobj.so /home/cspl/Pangolin/build/libpango_display.so /home/cspl/Pangolin/build/libpango_vars.so /home/cspl/Pangolin/build/libpango_windowing.so /home/cspl/Pangolin/build/libpango_opengl.so -lGLEW -lOpenGL -lGLX -lGLU /home/cspl/Pangolin/build/libpango_image.so /home/cspl/Pangolin/build/libpango_packetstream.so /home/cspl/Pangolin/build/libpango_core.so -lrt -lpthread /usr/lib/x86_64-linux-gnu/libopencv_highgui.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_datasets.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_plot.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_text.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_dnn.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ml.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_phase_unwrapping.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_optflow.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_ximgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_video.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_videoio.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgcodecs.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_objdetect.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_calib3d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_features2d.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_flann.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_photo.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_imgproc.so.4.2.0 /usr/lib/x86_64-linux-gnu/libopencv_core.so.4.2.0
